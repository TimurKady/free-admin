{% extends "layout/section.html" %}

{% block section_body %}
  <section class="col-md-6">
    <h1>Export Wizard</h1>
    {% if success %}<div class="alert alert-success">{{ success }}</div>{% endif %}
    {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
    <form id="export-form" class="mt-3">
      <div class="mb-3">
        <label for="fmt" class="form-label">Format</label>
        <select id="fmt" name="fmt" class="form-select">
          <option value="csv">CSV</option>
          <option value="json">JSON</option>
          <option value="xlsx">XLSX</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Fields</label>
        {% for field in fields %}
        <div class="form-check">
          <input type="checkbox" class="form-check-input" name="fields" value="{{ field }}" id="field-{{ loop.index }}">
          <label class="form-check-label" for="field-{{ loop.index }}">{{ field }}</label>
        </div>
        {% endfor %}
      </div>
      <input type="hidden" name="scope_token" id="scope_token">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <div class="d-flex gap-2">
        <button type="button" id="preview-btn" class="btn btn-secondary">Preview</button>
        <button type="submit" class="btn btn-primary">Export</button>
        <button type="button" id="back-btn" class="btn btn-outline-secondary">Back</button>
      </div>
    </form>
    <div id="export-feedback" class="mt-3"></div>
  </section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    class ExportWizard {
      constructor(form){
        this.form = form;
        this.previewBtn = document.getElementById('preview-btn');
        this.backBtn = document.getElementById('back-btn');
        this.feedback = document.getElementById('export-feedback');
        this.tokenField = document.getElementById('scope_token');
        const usp = new URLSearchParams(location.search);
        this.tokenField.value = usp.get('scope_token') || '';
        this.csrf = form.querySelector('input[name="csrf_token"]').value;
        this.base = location.pathname.endsWith('/') ? location.pathname : location.pathname + '/';
        this.bind();
      }

      bind(){
        this.previewBtn.addEventListener('click', () => this.preview());
        this.backBtn.addEventListener('click', () => this.goBack());
        this.form.addEventListener('submit', e => {
          e.preventDefault();
          this.run();
        });
      }

      async send(url, data){
        try{
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': this.csrf
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
          });
          if(!res.ok){
            const txt = await res.text();
            this.feedback.innerHTML = `<div class="alert alert-danger">${txt}</div>`;
            return null;
          }
          return await res.json();
        }catch(err){
          this.feedback.innerHTML = `<div class="alert alert-danger">${err}</div>`;
          return null;
        }
      }

      getFields(){
        return Array.from(this.form.querySelectorAll('input[name="fields"]:checked')).map(cb => cb.value);
      }

      async preview(){
        this.feedback.innerHTML = '';
        const token = this.tokenField.value;
        const data = {fmt: this.form.fmt.value, fields: this.getFields()};
        if(token){
          data.scope_token = token;
        }else{
          data.scope = {type: 'query', query: {filters: {}}};
        }
        const result = await this.send(this.base + 'preview', data);
        if(result){
          this.feedback.innerHTML = `<div class="alert alert-success">Preview: ${result.count} rows ready</div>`;
        }
      }

      async run(){
        this.feedback.innerHTML = '';
        const token = this.tokenField.value;
        const data = {fmt: this.form.fmt.value, fields: this.getFields()};
        if(token){
          data.scope_token = token;
        }else{
          data.scope = {type: 'query', query: {filters: {}}};
        }
        const result = await this.send(this.base + 'run', data);
        if(result && result.token){
          const link = this.base + 'done/' + result.token;
          this.feedback.innerHTML = `<div class="alert alert-success">Export ready. <a href="${link}">Download file</a></div>`;
        }
      }

      goBack(){
        history.back();
      }
    }

    new ExportWizard(document.getElementById('export-form'));
  </script>
{% endblock %}

<!-- # The End -->

