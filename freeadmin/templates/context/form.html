{% extends "layout/section.html" %}

{% block head %}
  {{ super() }}
  {% for href in assets.css %}
  <link rel="stylesheet" href="{{ href }}">
  {% endfor %}
{% endblock %}

{% block section_body %}
  <section class="d-flex flex-column w-100 h-100">
    <h2>{{ page_title }}</h2>
    <div id="form-spinner" class="text-center my-4">
      <div class="spinner-border" role="status"></div>
    </div>
    <div id="form-root" class="flex-grow-1 overflow-auto" style="min-height: 0;"></div>
    <div id="inline-root" class="mt-3" hidden>
      <!-- JS renders inline cards here -->
    </div>

    <!-- buttons -->
    <div class="d-flex gap-2 justify-content-end bg-light border rounded-2 mt-2 p-2">
      <button id="submit" class="btn btn-primary">Save</button>
      <button class="btn btn-secondary">Cancel</button>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  {% for src in assets.js %}
  <script src="{{ src }}"></script>
  {% endfor %}
  {% set _root_path = request.scope.get('root_path', '') %}
  {% if _root_path %}
    {% set _root_path = _root_path.rstrip('/') %}
  {% endif %}
  {% set _admin_form_relative = request.app.url_path_for(settings.static_route_name, path='admin-form.js') %}
  {% set _json_editor_relative = request.app.url_path_for(settings.static_route_name, path='vendors/json-editor/dist/jsoneditor.min.js') %}
  <script src="{{ static_href('admin-form.js') if static_href is defined else (_root_path ~ _admin_form_relative if _root_path else _admin_form_relative) }}"></script>
  <script src="{{ static_href('vendors/json-editor/dist/jsoneditor.min.js') if static_href is defined else (_root_path ~ _json_editor_relative if _root_path else _json_editor_relative) }}"></script>
  <script>
    if (window.ace?.config?.set) {
      {% set _ace_relative = request.app.url_path_for(settings.static_route_name, path='vendors/ace-builds/src-noconflict') %}
      {% set ace_base = static_href('vendors/ace-builds/src-noconflict') if static_href is defined else (_root_path ~ _ace_relative if _root_path else _ace_relative) %}
      window.ace.config.set("basePath", "{{ ace_base }}/");
    }
  </script>
  <script>
    const sectionPrefix = "{{ prefix }}{% if section_mode == 'settings' %}{{ SETTINGS_PREFIX }}{% else %}{{ ORM_PREFIX }}{% endif %}";
    (window.JSONEditorInitializer?.ready || Promise.resolve()).then(() => {
      window._form = new AdminFormEditor({ pk: "{{ pk or '' }}", prefix: sectionPrefix });
      window._form.load();
    });
  </script>
  <script>
    (function(){
      const usp = new URLSearchParams(location.search);
      const next = usp.get('next');
      const cancelBtn = document.querySelector('button.btn.btn-secondary');
      if (cancelBtn) {
        cancelBtn.onclick = function(){
          if (next) { location.href = next; }
          else { history.back(); }
        };
      }
    })();
  </script>
{% endblock %}

<!-- # The End -->

